
@managePageTemplate{
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Chart Management</h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
        <div class="row">
            <div class="col-lg-12">
                <p>
                    <button id="btn_new_chart" href="#popup_form" class="btn btn-success btn-mgnt-new">New Chart</button>
                    <button id="btn_edit_chart" href="#popup_form" class="btn btn-default" style="display: none;">Edit Chart</button>
                </p>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        Chart Query Result:
                    </div>
                    <!-- /.panel-heading -->
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover" id="dataTables-chart">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Chart Name</th>
                                        <th>Owner ID</th>
                                        <th>Owner Name</th>
                                        <th>Edit Count</th>
                                        <th>Last Modified</th>
                                        <th>Current Edit User</th>
                                        <th>Edit User</th>
                                        <th>Permitted Access</th>
                                        <th>Edit</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->

    <div id="popup_form" class="popupContainer" style="display:none;">
        <header class="popupHeader">
            <span class="header_title">Chart</span>
            <span class="modal_close"><i class="fa fa-times"></i></span>
        </header>

        <section class="popupBody SectionNewChart">
            <!-- Here Goes all alternative Forms -->
            <div class="pop_form">
                <div class="">
                    <form id="form_new_chart" method="POST">
                        <label>Chart Name<span style="color:red;">*</span>
                        </label>
                        <span style="color: red"></span>
                        <input type="text" name="new_chart_name" required>
                        <br>
                        <!-- <label>Owner ID</label>
                        <input type="text" name="new_chart_owner_id">
                        <br> -->
                        <label>Permission Type</label>
                        <select class="select-permission" name="new_chart_permission">
                            <option>public</option>
                            <option>specified</option>
                            <option>private</option>
                        </select>
                        <br>
                        <div class="area-specified_user">
                            <label>Permitted User(shortnames seperate by ;)</label>
                            <span style="color: red"></span>
                            <textarea type="text" name="new_chart_permitted_user" class="shortname-group" rows="3"></textarea>
                            <br>
                        </div>

                        <div class="action_btns centered">
                            <div class="">
                                <input type=submit id="submit_new_chart" class="btn btn-success" value="Create Chart">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- /.pop_form -->
        </section>
        <!-- /.SectionNewChart -->

        <section class="popupBody SectionEditChart">
            <!-- Here Goes all alternative Forms -->
            <div class="pop_form">
                <div class="">
                    <form id="form_edit_chart" method="POST">
                        <label>Chart ID<span style="color:red;">*</span>
                        </label>
                        <input type="text" id="chartid" name="chartid" readonly="readonly" required>
                        <br>
                        <label>Chart Name<span style="color:red;">*</span>
                        </label>
                        <input type="text" name="edit_chart_name" required>
                        <br>
                        <label>Owner ID</label>
                        <input type="text" name="edit_chart_owner_id">
                        <br>
                        <label>Permission Type</label>
                        <select class="select-permission" name="edit_chart_permission">
                            <option>public</option>
                            <option>specified</option>
                            <option>private</option>
                        </select>
                        <br>
                        <div class="area-specified_user">
                            <label>Permitted User(shortnames seperate by ;)</label>
                            <span style="color: red"></span>
                            <textarea type="text" name="edit_chart_permitted_user" class="shortname-group" rows="3"></textarea>
                            <br>
                        </div>

                        <div class="action_btns centered">
                            <div class="">
                                <input type=button id="submit_delete_chart" name="submit_delete_chart" class="btn btn-danger" data-toggle="confirmation" value="Delete Chart">
                                <input type=submit id="submit_edit_chart" name="submit_edit_chart" class="btn btn-warning" value="Update Chart">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- /.pop_form -->
        </section>
        <!-- /.SectionEditChart -->
    </div>
    <!-- /#popup_form -->

    <div id="lean_overlay" style="display: none; opacity: 0.6;"></div>

    <!-- bootbox.js -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.3.0/bootbox.js"></script>
    <!-- Bootstrap Confirmation -->
    <script type="text/javascript" src="@routes.Assets.at("js/bootstrap-tooltip.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/bootstrap-confirmation.js")"></script>


    <!-- Custom Theme JavaScript -->
    <script src="@routes.Assets.at("js/sb-admin-2.js")"></script>

    <!-- Page-Level Demo Scripts - Tables - Use for reference -->
    <script>
    var editor; // use a global for the submit and return data rendering
    $(document).ready(function() {

        var cTableSel = $('#dataTables-chart');
        var cTable = $('#dataTables-chart').DataTable({
            // "bAutoWidth":false,
            "ajax": '../chart/all/',
            "columns": [{
                "data": "uuid"
            }, {
                "data": "chartName"
            }, {
                "data": "ownerID"
            }, {
                "data": "OwnerName"
            }, {
                "data": "version"
            }, {
                "data": "timeLastModified"
            }, {
                "data": "editUser"
            }, {
                "data": "CUName"
            }, {
                "data": "permissionDisplay"
            }, {
                "data": "version"
            }],
            "columnDefs": [{
                "targets": [0],
                "visible": false,
                "searchable": false
            },{
                "targets": [3],
                "visible": false,
                "searchable": false
            },{
                "targets": [7],
                "visible": false,
                "searchable": false
            },{
                "targets": [9],
                "searchable": false,
                "defaultContent": "<button class='btnEditable'><i class='fa fa-pencil-square-o'></i></button>"
            }],
            // "aoColumns": [
            //     null,
            //     {"sWidth": "40px"},
            //     {"sWidth": "80px"},
            //     null,
            //     {"sWidth": "80px"},
            //     {"sWidth": "80px"},
            //     {"sWidth": "80px"},
            //     null,
            //     {"sWidth": "80px"},
            //     {"sWidth": "40px"}
            // ],
            "rowCallback": function(row, data) {
                    // generate hyperlink for chart name column
                    if (data["uuid"] != "") {
                        $('td:eq(0)', row).html('<a href="@routes.ChartCtrl.showChart()?chartid=' + data["uuid"] + '" title="' + data["chartName"] + '">' + data["chartName"] + '</a>');
                    }
                    if (data["timeLastModified"] != "") {
                        $('td:eq(3)', row).html(data["timeLastModified"].substring(0, data["timeLastModified"].length - 4));
                    }
                    $('td:eq(6)', row).html("<button class='btnEditable' title='Edit Chart'><i class='fa fa-pencil-square-o'></i></button>");
                    // $('td:eq(6)', row).html("<button class='btnEditable' title='Edit Chart'><i class='fa fa-pencil-square-o'></i></button><button class='btnUnlock' title='Force Unlock Chart'><i class='fa fa-unlock'></i></button>");
            }
                // ,
                // tableTools: {
                //     sRowSelect: "os",
                //     sRowSelector: 'td:first-child',
                //     aButtons: [
                //         { sExtends: "editor_create", editor: editor },
                //         { sExtends: "editor_edit",   editor: editor },
                //         { sExtends: "editor_remove", editor: editor }
                //     ]
                // }
        });
        // Activate the edit chart form on click of a table row
        // cTable.on( 'click', 'tbody tr', function (e) {
        //     alert(this);
        // } );
        /* Apply the tooltips */
        $('#dataTables-chart tbody tr[title]').tooltip({
            "delay": 0,
            "track": true,
            "fade": 250
        });
        // $( "#dataTables-chart tbody" ).dblclick(function() {
        //     $( "#btn_edit_chart" ).trigger( "click" );
        // });
        var CUR_EDIT_ROW;
        var openEditChartDialog = function(editRow){
            // console.log(editRow[0]);
            // console.log(editRow[0].id);
            // console.log( cTable.row( editRow ).data() );
            CUR_EDIT_ROW = editRow[0];
            $("input[name='chartid']").val(editRow[0].id);
            $("input[name='edit_chart_name']").val(cTable.row(editRow).data()['chartName']);
            $("input[name='edit_chart_owner_id']").val(cTable.row(editRow).data()['ownerID']);
            $("#form_edit_chart .select-permission option").filter(function() {
                return $(this).text() == cTable.row(editRow).data()['permission'];
            }).first().prop("selected", true);
            presetSelectFunc( $("#form_edit_chart") );
            $("textarea[name='edit_chart_permitted_user']").val(cTable.row(editRow).data()['permittedUser']);
            $("#btn_edit_chart").trigger("click");
        }
        // $('#dataTables-chart tbody').on('dblclick', 'tr', function() {
        //     openEditChartDialog(this);
        // });
        $('#dataTables-chart tbody').on('click', '.btnEditable', function() {
            openEditChartDialog($(this).parent().parent());
        });

        $('.select-permission').change(function() {
            presetSelectFunc( $(this).parent() );
        });

        presetSelectFunc = function(targetForm){
            if ("specified" === targetForm.find('.select-permission').find(':selected').val()) {
                targetForm.find('.area-specified_user').show();
            } else {
                targetForm.find('.area-specified_user').hide();
            }
        }
        

        // $('button.editor_create').on('click', function (e) {
        //     e.preventDefault();
        //     editor.create(
        //         'Create new record',
        //         {
        //             "label": "Add",
        //             "fn": function () {
        //                 editor.submit();
        //             }
        //         }
        //     );
        // });

        // Edit record
        // cTable.on('click', 'a.editor_edit', function (e) {
        //     e.preventDefault();

        //     editor.edit(
        //         $(this).parents('tr')[0],
        //         'Edit record',
        //         { "label": "Update", "fn": function () { editor.submit(); } }
        //     );
        // } );


        // For new chart form
        $('#btn_new_chart').click(function() {
            $("form#form_new_chart")[0].reset();
            $("#form_new_chart input[name=new_chart_name]").prev().text("");
            $("#popup_form .SectionNewChart").show();
            $("#popup_form .SectionEditChart").hide();
            return false;
        });
        $('#btn_edit_chart').click(function() {
            $("#popup_form .SectionNewChart").hide();
            $("#popup_form .SectionEditChart").show();
            return false;
        });


        $('input[name=new_chart_name]').focusout(function(){
            var self = $("input[name=new_chart_name]")
            self.prev().text("");
            $.ajax({
                type: "GET",
                data: {
                    name: $("input[name=new_chart_name]").val()
                },
                url: "../chart/count/",
                success: function(respose, text, xhr) {
                    if(respose>0){
                        self.prev().text("Chart with same name already exist.");
                    }else if(respose==0){
                        self.prev().text("");
                    }
                }
            });
        });
        var re_permitted_user = new RegExp("^[A-Za-z0-9]{0,}?(;[A-Za-z0-9]{1,}){0,};?$");
        $('textarea.shortname-group').keyup(function(){
            $(this).prev().text(re_permitted_user.test($(this).val()) 
                ? "":"Invalid input of shortnames(split by ;)");
        });

        $("#btn_new_chart").leanModal({
            top: 100,
            overlay: 0.6,
            closeButton: ".modal_close"
        });
        $("#btn_edit_chart").leanModal({
            top: 100,
            overlay: 0.6,
            closeButton: ".modal_close"
        });

        $('form#form_new_chart').submit(function(e) {
            var formData = new FormData(this);
            var submitSuccessCallbackFn = function(i) {
                cTableSel.dataTable().fnAddData(i);
            }
            var cont_submit = true;
            if($("#form_new_chart input[name=new_chart_name]").prev().text() != ""){
                cont_submit = confirm("Chart with same name already exist, are you still want to continue?");
            }
            if (e != null) {
                e.preventDefault();
            }
            if(cont_submit){
                submitFunc(e, "../chart/", formData, "POST", submitSuccessCallbackFn);
                $(this)[0].reset();
            }
        });
        $('form#form_edit_chart').submit(function(e) {
            var formData = new FormData(this);
            var submitSuccessCallbackFn = function(i) {
                // console.log( cTableSel.dataTable().fnSettings().aoData );
                // console.log( CUR_EDIT_ROW );
                // console.log( cTable );
                // console.log( cTableSel.dataTable() );
                var pos = cTableSel.dataTable().fnGetPosition(CUR_EDIT_ROW);
                cTableSel.dataTable().fnUpdate(i, pos);
            }
            submitFunc(e, "../chart/", formData, "PUT", submitSuccessCallbackFn);
            $(this)[0].reset();
        });

        $('[data-toggle="confirmation"]').confirmation({
            "singleton" : true,
            "popout" : true,
            "onConfirm" : function(){
                var chartid = $('form#form_edit_chart #chartid').val()
                var formData = new FormData($('form#form_edit_chart'));
                var submitSuccessCallbackFn = function(i) {
                    var pos = cTableSel.dataTable().fnGetPosition(CUR_EDIT_ROW);
                    cTableSel.dataTable().fnDeleteRow(pos);
                }
                submitFunc(null, "../chart/" + chartid, formData, "DELETE", submitSuccessCallbackFn);
                $('form#form_edit_chart')[0].reset();
            }
        });

        // $('#submit_delete_chart').click(function() {
        //     var chartid = $('form#form_edit_chart #chartid').val()
        //     var formData = new FormData($('form#form_edit_chart'));
        //     var submitSuccessCallbackFn = function(i) {
        //         var pos = cTableSel.dataTable().fnGetPosition(editRow);
        //         cTableSel.dataTable().fnDeleteRow(pos);
        //     }
        //     bootbox.confirm("Are you sure?", function(result) {
        //         console.log(result===true);
        //         if(true==result){
        //             submitFunc(null, "../chart/" + chartid, formData, "DELETE", submitSuccessCallbackFn);
        //             $('form#form_edit_chart')[0].reset();
        //         }
        //     }); 
            
        // });

        var submitFunc = function(e, url, formData, submitMethod, successCallback) {
            if (e != null) {
                e.preventDefault();
            }
            $.ajax({
                type: submitMethod,
                url: url,
                cache: false,
                data: formData,
                processData: false, // Don't process the files
                contentType: false, // Set content type to false as jQuery will tell the server its a query string request
                success: function(respose, text, xhr) {
                    console.log("submitFunc:" + text + ", " + respose + ", url=" + url);
                    $("#popup_form").hide();
                    $("#lean_overlay").hide();
                    successCallback(respose);
                    // var j = respose;
                    // cTableSel.dataTable().fnAddData(j);
                },
                error: function(msg) {
                    console.log(msg);
                    if(401==msg.status){
                        alert(msg.status + ", " + msg.statusText + "\n" + "Unauthorized access. Are you readonly user? You may requrest permission from admin.");
                    }else if(403==msg.status){
                        alert(msg.status + ", " + msg.statusText + "\n" + "Forbidden access. Make sure your have permission to do so. You may requrest permission from admin or owner.");
                    }else if(404==msg.status){
                        alert(msg.status + ", " + msg.statusText + "\n" + "Not Found. What you are looking for may already deleted.");
                    }else{
                        alert(msg.status + ", " + msg.statusText + "\n" + "Unkown error. Make sure your input and have permission or connection to server.");
                    }
                }
            })
        }

    });
    // END $(document).ready
    </script>

}
